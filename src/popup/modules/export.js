// export.js - ä¼šè¯å¯¼å‡ºåŠŸèƒ½

import { state } from './state.js';
import * as api from './api.js';
import { showToast } from './toast.js';
import { t } from './i18n.js';

/**
 * å°†æ ‘å½¢ç»“æ„è½¬æ¢ä¸ºMarkdownæ ¼å¼
 * @param {Object} session - ä¼šè¯æ•°æ®
 * @returns {string}
 */
function convertToMarkdown(session) {
  const lines = [];
  lines.push(`# ${session.name}`);
  lines.push('');
  lines.push(`> åˆ›å»ºæ—¶é—´: ${new Date(session.startTime).toLocaleString()}`);
  lines.push('');
  
  function buildMarkdown(node, depth = 0) {
    const indent = '  '.repeat(depth);
    const title = node.title || 'æ— æ ‡é¢˜';
    const url = node.url;
    const visitInfo = node.visitCount > 1 ? ` (è®¿é—®${node.visitCount}æ¬¡)` : '';
    
    lines.push(`${indent}- [${title}](${url})${visitInfo}`);
    
    if (node.children && node.children.length > 0) {
      for (const childId of node.children) {
        const child = session.allNodes[childId];
        if (child) {
          buildMarkdown(child, depth + 1);
        }
      }
    }
  }
  
  for (const rootId of session.rootNodes) {
    const root = session.allNodes[rootId];
    if (root) {
      buildMarkdown(root);
    }
  }
  
  lines.push('');
  lines.push('---');
  lines.push('');
  lines.push('*Generated by MindGit*');
  
  return lines.join('\n');
}

/**
 * å°†æ ‘å½¢ç»“æ„è½¬æ¢ä¸ºJSONæ ¼å¼
 * @param {Object} session - ä¼šè¯æ•°æ®
 * @returns {string}
 */
function convertToJSON(session) {
  const exportData = {
    name: session.name,
    createdAt: new Date(session.startTime).toISOString(),
    exportTime: new Date().toISOString(),
    nodes: []
  };
  
  function buildJSON(node) {
    const result = {
      title: node.title,
      url: node.url,
      visitCount: node.visitCount || 1,
      timestamp: node.timestamp,
      children: []
    };
    
    if (node.children && node.children.length > 0) {
      for (const childId of node.children) {
        const child = session.allNodes[childId];
        if (child) {
          result.children.push(buildJSON(child));
        }
      }
    }
    
    return result;
  }
  
  for (const rootId of session.rootNodes) {
    const root = session.allNodes[rootId];
    if (root) {
      exportData.nodes.push(buildJSON(root));
    }
  }
  
  return JSON.stringify(exportData, null, 2);
}

/**
 * å°†æ ‘å½¢ç»“æ„è½¬æ¢ä¸ºHTMLæ ¼å¼
 * @param {Object} session - ä¼šè¯æ•°æ®
 * @returns {string}
 */
function convertToHTML(session) {
  const lines = [];
  lines.push('<!DOCTYPE html>');
  lines.push('<html lang="zh-CN">');
  lines.push('<head>');
  lines.push(`<meta charset="UTF-8">`);
  lines.push(`<title>${escapeHtml(session.name)} - MindGit å¯¼å‡º</title>`);
  lines.push('<style>');
  lines.push(`
    body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; max-width: 800px; margin: 40px auto; padding: 0 20px; background: #f5f7fa; }
    h1 { color: #2c3e50; border-bottom: 2px solid #4a90d9; padding-bottom: 10px; }
    .meta { color: #7f8c8d; font-size: 14px; margin: 20px 0; }
    ul { list-style: none; padding-left: 20px; }
    li { margin: 8px 0; }
    a { color: #4a90d9; text-decoration: none; }
    a:hover { text-decoration: underline; }
    .visit-count { color: #7f8c8d; font-size: 12px; }
    .depth-0 { font-weight: 600; }
    .depth-1 { margin-left: 20px; }
    .depth-2 { margin-left: 40px; }
    .depth-3 { margin-left: 60px; }
    footer { margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd; color: #95a5a6; font-size: 12px; }
  `);
  lines.push('</style>');
  lines.push('</head>');
  lines.push('<body>');
  lines.push(`<h1>${escapeHtml(session.name)}</h1>`);
  lines.push(`<div class="meta">åˆ›å»ºæ—¶é—´: ${new Date(session.startTime).toLocaleString()}</div>`);
  lines.push('<ul>');
  
  function buildHTML(node, depth = 0) {
    const title = escapeHtml(node.title || 'æ— æ ‡é¢˜');
    const url = escapeHtml(node.url);
    const visitInfo = node.visitCount > 1 ? ` <span class="visit-count">(è®¿é—®${node.visitCount}æ¬¡)</span>` : '';
    
    lines.push(`<li class="depth-${Math.min(depth, 3)}"><a href="${url}" target="_blank">${title}</a>${visitInfo}</li>`);
    
    if (node.children && node.children.length > 0) {
      lines.push('<ul>');
      for (const childId of node.children) {
        const child = session.allNodes[childId];
        if (child) {
          buildHTML(child, depth + 1);
        }
      }
      lines.push('</ul>');
    }
  }
  
  for (const rootId of session.rootNodes) {
    const root = session.allNodes[rootId];
    if (root) {
      buildHTML(root);
    }
  }
  
  lines.push('</ul>');
  lines.push('<footer>Generated by MindGit</footer>');
  lines.push('</body>');
  lines.push('</html>');
  
  return lines.join('\n');
}

/**
 * HTML è½¬ä¹‰
 */
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

/**
 * ä¸‹è½½æ–‡ä»¶
 * @param {string} content - æ–‡ä»¶å†…å®¹
 * @param {string} filename - æ–‡ä»¶å
 * @param {string} mimeType - MIME ç±»å‹
 */
function downloadFile(content, filename, mimeType) {
  const blob = new Blob([content], { type: mimeType });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

/**
 * åˆ›å»ºå¯¼å‡ºæ ¼å¼é€‰æ‹©å¯¹è¯æ¡†
 * @returns {Promise<string|null>} é€‰æ‹©çš„æ ¼å¼æˆ– null
 */
function showExportFormatDialog() {
  return new Promise((resolve) => {
    // ç§»é™¤å·²å­˜åœ¨çš„å¯¹è¯æ¡†
    const existing = document.getElementById('exportFormatModal');
    if (existing) existing.remove();
    
    const modal = document.createElement('div');
    modal.id = 'exportFormatModal';
    modal.className = 'modal active';
    modal.innerHTML = `
      <div class="modal-content" style="max-width: 320px;">
        <div class="modal-header">
          <h2>ğŸ“¤ é€‰æ‹©å¯¼å‡ºæ ¼å¼</h2>
          <button class="close-btn" id="closeExportFormat">&times;</button>
        </div>
        <div class="modal-body">
          <div class="export-options" style="display: flex; flex-direction: column; gap: 10px;">
            <button class="export-option-btn" data-format="markdown" style="padding: 14px; border: 1.5px solid var(--border-color); border-radius: 10px; background: var(--card-bg); cursor: pointer; text-align: left; transition: all 0.2s;">
              <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 4px;">ğŸ“ Markdown</div>
              <div style="font-size: 12px; color: var(--text-muted);">çº¯æ–‡æœ¬æ ¼å¼ï¼Œé€‚åˆå¯¼å…¥åˆ°ç¬”è®°è½¯ä»¶</div>
            </button>
            <button class="export-option-btn" data-format="html" style="padding: 14px; border: 1.5px solid var(--border-color); border-radius: 10px; background: var(--card-bg); cursor: pointer; text-align: left; transition: all 0.2s;">
              <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 4px;">ğŸŒ HTML</div>
              <div style="font-size: 12px; color: var(--text-muted);å®Œæ•´ç½‘é¡µï¼Œå¯ç”¨æµè§ˆå™¨æ‰“å¼€æŸ¥çœ‹</div>
            </button>
          </div>
        </div>
      </div>
    `;
    
    document.body.appendChild(modal);
    
    // å…³é—­æŒ‰é’®
    modal.querySelector('#closeExportFormat').addEventListener('click', () => {
      modal.remove();
      resolve(null);
    });
    
    // ç‚¹å‡»èƒŒæ™¯å…³é—­
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        modal.remove();
        resolve(null);
      }
    });
    
    // ESC å…³é—­
    const handleEsc = (e) => {
      if (e.key === 'Escape') {
        modal.remove();
        resolve(null);
        document.removeEventListener('keydown', handleEsc);
      }
    };
    document.addEventListener('keydown', handleEsc);
    
    // æ ¼å¼é€‰æ‹©
    modal.querySelectorAll('.export-option-btn').forEach(btn => {
      btn.addEventListener('mouseenter', () => {
        btn.style.borderColor = 'var(--primary-color)';
        btn.style.background = 'var(--hover-bg)';
      });
      btn.addEventListener('mouseleave', () => {
        btn.style.borderColor = 'var(--border-color)';
        btn.style.background = 'var(--card-bg)';
      });
      btn.addEventListener('click', () => {
        const format = btn.dataset.format;
        modal.remove();
        document.removeEventListener('keydown', handleEsc);
        resolve(format);
      });
    });
  });
}

/**
 * å¯¼å‡ºå½“å‰ä¼šè¯
 */
export async function exportCurrentSession() {
  if (!state.currentSessionId) {
    showToast('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªä¼šè¯');
    return;
  }
  
  const result = await api.getSessionTree(state.currentSessionId);
  if (!result.session) {
    showToast('ä¼šè¯ä¸å­˜åœ¨');
    return;
  }
  
  const session = result.session;
  
  // æ˜¾ç¤ºæ ¼å¼é€‰æ‹©å¯¹è¯æ¡†
  const format = await showExportFormatDialog();
  if (!format) return;
  
  const timestamp = new Date().toISOString().slice(0, 10);
  const baseFilename = `${session.name.replace(/[^\w\u4e00-\u9fa5]/g, '_')}_${timestamp}`;
  
  if (format === 'markdown') {
    const content = convertToMarkdown(session);
    downloadFile(content, `${baseFilename}.md`, 'text/markdown');
    showToast('å·²å¯¼å‡ºä¸º Markdown');
  } else if (format === 'html') {
    const content = convertToHTML(session);
    downloadFile(content, `${baseFilename}.html`, 'text/html');
    showToast('å·²å¯¼å‡ºä¸º HTML');
  }
}

/**
 * å¯¼å‡ºæ‰€æœ‰ä¼šè¯
 */
export async function exportAllSessions() {
  const result = await api.getSessions();
  const sessions = result.sessions;
  
  if (!sessions || Object.keys(sessions).length === 0) {
    showToast('æ²¡æœ‰å¯å¯¼å‡ºçš„ä¼šè¯');
    return;
  }
  
  const exportData = {
    exportTime: new Date().toISOString(),
    totalSessions: Object.keys(sessions).length,
    sessions: sessions
  };
  
  const content = JSON.stringify(exportData, null, 2);
  const timestamp = new Date().toISOString().slice(0, 10);
  downloadFile(content, `mindgit_all_sessions_${timestamp}.json`, 'application/json');
  showToast('å·²å¯¼å‡ºæ‰€æœ‰ä¼šè¯');
}
